<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Rate Limiter Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #333; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; color: white; }
        .status.healthy { background: #4CAF50; }
        .status.unhealthy { background: #f44336; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .metric { text-align: center; }
        .metric h3 { margin: 0; color: #666; }
        .metric .value { font-size: 2em; font-weight: bold; color: #333; }
        .rules-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rules-table th, .rules-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .rules-table th { background-color: #f2f2f2; }
        .enabled { color: #4CAF50; font-weight: bold; }
        .disabled { color: #f44336; }
        .refresh-btn { background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #1976D2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="header">üõ°Ô∏è API Rate Limiter Dashboard</h1>
            <div style="text-align: center;">
                <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
                <span id="lastUpdated" style="margin-left: 20px; color: #666;"></span>
            </div>
        </div>

        <div class="grid">
            <div class="card metric">
                <h3>Service Status</h3>
                <div class="value">
                    <span id="serviceStatus" class="status">Loading...</span>
                </div>
            </div>
            <div class="card metric">
                <h3>Redis Connection</h3>
                <div class="value">
                    <span id="redisStatus" class="status">Loading...</span>
                </div>
            </div>
            <div class="card metric">
                <h3>Uptime</h3>
                <div class="value" id="uptime">Loading...</div>
            </div>
            <div class="card metric">
                <h3>Active Rules</h3>
                <div class="value" id="activeRules">Loading...</div>
            </div>
        </div>

        <div class="card">
            <h2>Rate Limiting Rules</h2>
            <table class="rules-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Pattern</th>
                        <th>Method</th>
                        <th>Limit</th>
                        <th>Algorithm</th>
                        <th>Status</th>
                        <th>Priority</th>
                    </tr>
                </thead>
                <tbody id="rulesTable">
                    <tr><td colspan="7">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>Default Configuration</h2>
            <div id="defaultConfig">Loading...</div>
        </div>

        <!-- API Key Management Section -->
        <div class="card">
            <h2>üîë API Key Management</h2>
            
            <!-- API Key Generation Form -->
            <div style="margin-bottom: 20px;">
                <h3>Generate New API Key</h3>
                <form id="generateKeyForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="keyName" placeholder="API Key Name" required>
                    <select id="keyTier" required>
                        <option value="">Select Tier</option>
                        <option value="free">Free</option>
                        <option value="premium">Premium</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                    <input type="text" id="userId" placeholder="User ID (optional)">
                    <button type="submit" style="background: #4CAF50; color: white; border: none; padding: 10px; border-radius: 4px;">Generate Key</button>
                </form>
                <div id="generatedKey" style="display: none; background: #e8f5e8; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>Generated API Key:</strong>
                    <code id="newApiKey" style="background: white; padding: 5px; border-radius: 3px; display: block; margin-top: 5px; word-break: break-all;"></code>
                    <small style="color: #666;">‚ö†Ô∏è Save this key securely - it won't be shown again!</small>
                </div>
            </div>

            <!-- User Keys Lookup -->
            <div style="margin-bottom: 20px;">
                <h3>View User's API Keys</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="lookupUserId" placeholder="Enter User ID" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="lookupUserKeys()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px;">Lookup Keys</button>
                </div>
                <div id="userKeysResult"></div>
            </div>

            <!-- Available Tiers -->
            <div>
                <h3>Available Tiers</h3>
                <div id="tiersInfo" class="grid">
                    <!-- Tiers will be loaded here -->
                </div>
            </div>
        </div>

        <!-- JWT Authentication Section -->
        <div class="card">
            <h2>üîê JWT Authentication</h2>
            
            <!-- JWT Login Form -->
            <div style="margin-bottom: 20px;">
                <h3>Login with JWT</h3>
                <form id="jwtLoginForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                    <select id="loginEmail" required>
                        <option value="">Select Demo User</option>
                        <option value="admin@example.com">Admin User</option>
                        <option value="premium@example.com">Premium User</option>
                        <option value="user@example.com">Standard User</option>
                        <option value="guest@example.com">Guest User</option>
                    </select>
                    <input type="password" id="loginPassword" placeholder="Password (demo123)" value="demo123" required>
                    <button type="submit" style="background: #9C27B0; color: white; border: none; padding: 10px; border-radius: 4px;">Login</button>
                </form>
                <div id="loginResult" style="display: none; background: #e8f5e8; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>JWT Token:</strong>
                    <code id="jwtToken" style="background: white; padding: 5px; border-radius: 3px; display: block; margin-top: 5px; word-break: break-all;"></code>
                    <div style="margin-top: 10px;">
                        <strong>User Info:</strong>
                        <div id="userInfo"></div>
                    </div>
                </div>
            </div>

            <!-- JWT Test Actions -->
            <div style="margin-bottom: 20px;">
                <h3>Test JWT Endpoints</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <button onclick="verifyToken()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px;">Verify Token</button>
                    <button onclick="testAdminEndpoint()" style="background: #F44336; color: white; border: none; padding: 8px 16px; border-radius: 4px;">Test Admin</button>
                    <button onclick="testPremiumEndpoint()" style="background: #FF9800; color: white; border: none; padding: 8px 16px; border-radius: 4px;">Test Premium</button>
                    <button onclick="testSecureEndpoint()" style="background: #795548; color: white; border: none; padding: 8px 16px; border-radius: 4px;">Test Secure</button>
                    <button onclick="clearToken()" style="background: #607D8B; color: white; border: none; padding: 8px 16px; border-radius: 4px;">Clear Token</button>
                </div>
                <div id="jwtTestResult" style="margin-top: 10px;"></div>
            </div>

            <!-- JWT Info -->
            <div>
                <h3>JWT Authentication Info</h3>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 4px;">
                    <p><strong>Demo Users:</strong></p>
                    <ul style="margin: 10px 0;">
                        <li><code>admin@example.com</code> - Full admin access, highest rate limits</li>
                        <li><code>premium@example.com</code> - Premium features, higher rate limits</li>
                        <li><code>user@example.com</code> - Standard user access, normal rate limits</li>
                        <li><code>guest@example.com</code> - Limited access, lower rate limits</li>
                    </ul>
                    <p><strong>Password:</strong> <code>demo123</code> (for all demo users)</p>
                    <p><strong>Features:</strong> Role-based access control, permission-based endpoints, dynamic rate limiting based on user role</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function fetchData() {
            try {
                const [healthResponse, configResponse] = await Promise.all([
                    fetch('/health'),
                    fetch('/config')
                ]);
                
                const health = await healthResponse.json();
                const config = await configResponse.json();
                
                return { health, config };
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        function updateDashboard(data) {
            if (!data) return;
            
            const { health, config } = data;
            
            // Update service status
            const serviceStatus = document.getElementById('serviceStatus');
            serviceStatus.textContent = health.status.toUpperCase();
            serviceStatus.className = `status ${health.status === 'ok' ? 'healthy' : 'unhealthy'}`;
            
            // Update Redis status
            const redisStatus = document.getElementById('redisStatus');
            redisStatus.textContent = health.redis ? 'CONNECTED' : 'DISCONNECTED';
            redisStatus.className = `status ${health.redis ? 'healthy' : 'unhealthy'}`;
            
            // Update uptime
            const uptimeMinutes = Math.floor(health.uptime / 60);
            const uptimeSeconds = Math.floor(health.uptime % 60);
            document.getElementById('uptime').textContent = `${uptimeMinutes}m ${uptimeSeconds}s`;
            
            // Update active rules count
            const activeRulesCount = config.rules.filter(rule => rule.enabled).length;
            document.getElementById('activeRules').textContent = activeRulesCount;
            
            // Update rules table
            const rulesTable = document.getElementById('rulesTable');
            rulesTable.innerHTML = config.rules.map(rule => `
                <tr>
                    <td>${rule.name}</td>
                    <td><code>${rule.pattern}</code></td>
                    <td>${rule.method || 'ALL'}</td>
                    <td>${rule.config.max}/${rule.config.windowMs/1000}s</td>
                    <td>${rule.config.algorithm}</td>
                    <td class="${rule.enabled ? 'enabled' : 'disabled'}">
                        ${rule.enabled ? 'ENABLED' : 'DISABLED'}
                    </td>
                    <td>${rule.priority}</td>
                </tr>
            `).join('');
            
            // Update default config
            document.getElementById('defaultConfig').innerHTML = `
                <p><strong>Algorithm:</strong> ${config.defaultRateLimit.algorithm}</p>
                <p><strong>Window:</strong> ${config.defaultRateLimit.windowMs/1000} seconds</p>
                <p><strong>Max Requests:</strong> ${config.defaultRateLimit.max}</p>
            `;
            
            // Update timestamp
            document.getElementById('lastUpdated').textContent = 
                `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        async function refreshData() {
            const data = await fetchData();
            updateDashboard(data);
        }

        // Initial load and auto-refresh
        refreshData();
        setInterval(refreshData, 30000); // Refresh every 30 seconds

        // API Key Management
        document.getElementById('generateKeyForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const keyName = document.getElementById('keyName').value;
            const keyTier = document.getElementById('keyTier').value;
            const userId = document.getElementById('userId').value;
            
            try {
                const response = await fetch('/generate-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyName, keyTier, userId })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('newApiKey').textContent = result.apiKey;
                    document.getElementById('generatedKey').style.display = 'block';
                } else {
                    alert('Error generating key: ' + result.message);
                }
            } catch (error) {
                console.error('Error generating API key:', error);
            }
        });

        async function lookupUserKeys() {
            const userId = document.getElementById('lookupUserId').value;
            const resultDiv = document.getElementById('userKeysResult');
            resultDiv.innerHTML = 'Loading...';
            
            try {
                const response = await fetch('/user-keys/' + encodeURIComponent(userId));
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = result.keys.length > 0 ? 
                        result.keys.map(key => `<div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;">
                            <strong>Key:</strong> <code style="word-break: break-all;">${key.key}</code><br>
                            <strong>Status:</strong> ${key.enabled ? '<span class="status healthy">ENABLED</span>' : '<span class="status unhealthy">DISABLED</span>'}<br>
                            <strong>Limits:</strong> ${key.config.max}/${key.config.windowMs/1000}s<br>
                            <strong>Algorithm:</strong> ${key.config.algorithm}<br>
                            <strong>Created:</strong> ${new Date(key.createdAt).toLocaleString()}
                        </div>`).join('') : 'No keys found for this user.';
                } else {
                    resultDiv.innerHTML = 'Error fetching keys: ' + result.message;
                }
            } catch (error) {
                console.error('Error fetching user keys:', error);
                resultDiv.innerHTML = 'Error fetching keys. Please try again later.';
            }
        }

        // Load available tiers on dashboard load
        (async function loadTiers() {
            const tiersInfo = document.getElementById('tiersInfo');
            tiersInfo.innerHTML = 'Loading...';
            
            try {
                const response = await fetch('/tiers');
                const result = await response.json();
                
                if (result.success) {
                    tiersInfo.innerHTML = result.tiers.map(tier => `
                        <div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <strong>${tier.name}</strong><br>
                            <em>${tier.description}</em><br>
                            <strong>Limits:</strong> ${tier.config.max}/${tier.config.windowMs/1000}s<br>
                            <strong>Algorithm:</strong> ${tier.config.algorithm}
                        </div>
                    `).join('');
                } else {
                    tiersInfo.innerHTML = 'Error loading tiers: ' + result.message;
                }
            } catch (error) {
                console.error('Error loading tiers:', error);
                tiersInfo.innerHTML = 'Error loading tiers. Please try again later.';
            }
        
        // API Key Management Functions
        document.getElementById('generateKeyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('keyName').value;
            const tier = document.getElementById('keyTier').value;
            const userId = document.getElementById('userId').value;
            
            try {
                const response = await fetch('/api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        tier,
                        userId: userId || undefined,
                    }),
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show the generated key
                    document.getElementById('newApiKey').textContent = result.apiKey;
                    document.getElementById('generatedKey').style.display = 'block';
                    
                    // Reset form
                    document.getElementById('generateKeyForm').reset();
                    
                    // Auto-hide after 30 seconds
                    setTimeout(() => {
                        document.getElementById('generatedKey').style.display = 'none';
                    }, 30000);
                } else {
                    alert('Error generating API key: ' + result.message);
                }
            } catch (error) {
                console.error('Error generating API key:', error);
                alert('Error generating API key. Please try again.');
            }
        });
        
        async function lookupUserKeys() {
            const userId = document.getElementById('lookupUserId').value;
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }
            
            try {
                const response = await fetch(`/api-keys?userId=${encodeURIComponent(userId)}`);
                const result = await response.json();
                
                const resultDiv = document.getElementById('userKeysResult');
                
                if (response.ok) {
                    if (result.keys.length === 0) {
                        resultDiv.innerHTML = '<p>No API keys found for this user.</p>';
                    } else {
                        resultDiv.innerHTML = `
                            <table class="rules-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Tier</th>
                                        <th>Created</th>
                                        <th>Last Used</th>
                                        <th>Status</th>
                                        <th>Usage</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.keys.map(key => `
                                        <tr>
                                            <td>${key.name}</td>
                                            <td>${key.tier}</td>
                                            <td>${new Date(key.created).toLocaleDateString()}</td>
                                            <td>${key.lastUsed ? new Date(key.lastUsed).toLocaleDateString() : 'Never'}</td>
                                            <td class="${key.isActive ? 'enabled' : 'disabled'}">${key.isActive ? 'Active' : 'Revoked'}</td>
                                            <td>${key.usage.currentMonthRequests} / ${key.usage.totalRequests} total</td>
                                            <td>
                                                ${key.isActive ? `<button onclick="revokeKey('${key.id}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">Revoke</button>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `<p style="color: #f44336;">Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error looking up user keys:', error);
                document.getElementById('userKeysResult').innerHTML = '<p style="color: #f44336;">Error looking up keys. Please try again.</p>';
            }
        }
        
        async function revokeKey(keyId) {
            if (!confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api-keys/${keyId}`, {
                    method: 'DELETE',
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('API key revoked successfully');
                    // Refresh the user keys if they're currently displayed
                    const userId = document.getElementById('lookupUserId').value;
                    if (userId) {
                        lookupUserKeys();
                    }
                } else {
                    alert('Error revoking API key: ' + result.message);
                }
            } catch (error) {
                console.error('Error revoking API key:', error);
                alert('Error revoking API key. Please try again.');
            }
        }

        // JWT Authentication
        document.getElementById('jwtLoginForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('jwtToken').textContent = result.token;
                    document.getElementById('userInfo').innerHTML = `
                        <p><strong>Email:</strong> ${result.user.email}</p>
                        <p><strong>Role:</strong> ${result.user.role}</p>
                        <p><strong>Tier:</strong> ${result.user.tier}</p>
                    `;
                    document.getElementById('loginResult').style.display = 'block';
                } else {
                    alert('Error logging in: ' + result.message);
                }
            } catch (error) {
                console.error('Error during login:', error);
            }
        });

        async function verifyToken() {
            const token = document.getElementById('jwtToken').textContent;
            if (!token) {
                alert('Please login first to get a JWT token');
                return;
            }
            
            const resultDiv = document.getElementById('jwtTestResult');
            resultDiv.innerHTML = 'Verifying token...';
            
            try {
                const response = await fetch('/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                if (response.ok) {
                    resultDiv.innerHTML = `<span style="color: #4CAF50;">‚úÖ Token is valid! User: ${result.user.email} (${result.user.role})</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: #f44336;">‚ùå Invalid token: ${result.message}</span>`;
                }
            } catch (error) {
                console.error('Error verifying token:', error);
                resultDiv.innerHTML = '<span style="color: #f44336;">‚ùå Error verifying token. Please try again.</span>';
            }
        }

        async function testAdminEndpoint() {
            await testJWTEndpoint('/admin/users', 'Admin');
        }

        async function testPremiumEndpoint() {
            await testJWTEndpoint('/premium/features', 'Premium');
        }

        async function testSecureEndpoint() {
            await testJWTEndpoint('/secure/data', 'Secure');
        }

        async function testJWTEndpoint(endpoint, name) {
            const token = document.getElementById('jwtToken').textContent;
            if (!token) {
                alert('Please login first to get a JWT token');
                return;
            }
            
            const resultDiv = document.getElementById('jwtTestResult');
            resultDiv.innerHTML = `Testing ${name} endpoint...`;
            
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                if (response.ok) {
                    resultDiv.innerHTML = `<span style="color: #4CAF50;">‚úÖ ${name} endpoint test successful! ${JSON.stringify(result.data || result.message)}</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: #f44336;">‚ùå ${name} endpoint test failed: ${result.message}</span>`;
                }
            } catch (error) {
                console.error(`Error testing ${name} endpoint:`, error);
                resultDiv.innerHTML = `<span style="color: #f44336;">‚ùå Error testing ${name} endpoint. Please try again.</span>`;
            }
        }

        function clearToken() {
            document.getElementById('jwtToken').textContent = '';
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('loginResult').style.display = 'none';
            document.getElementById('jwtTestResult').innerHTML = '';
        }
    </script>
</body>
</html>
